# Ingress Controller

## Minikube

Vamos a desplegar dos aplicaciones en Minikube y las vamos a servir bajo el mismo DNS cambiando el contexto en el que servimos cada una.

1. Comprobar que Minikube tiene habilitado el addons ingress

Podemos verlo ejecutando:

`minikube addons list`

y viendo que aparece habilitado

```
- addon-manager: enabled
- dashboard: enabled
- default-storageclass: enabled
- efk: disabled
- freshpod: disabled
- gvisor: disabled
- heapster: enabled
- ingress: enabled   <--- Está habilitado
- kube-dns: disabled
- metrics-server: enabled
- nvidia-driver-installer: disabled
- nvidia-gpu-device-plugin: disabled
- registry: disabled
- registry-creds: disabled
- storage-provisioner: enabled
- storage-provisioner-gluster: disabled
```

En caso contrario lo habilitamos:

`minikube addons enable ingress`

2. Crear un certificado TLS

Aunque es un certificado autofirmado, es buena práctica usar certificados en nuestros servicios. 

Lo creamos de la siguiente manera:

`openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj "/CN=curso.minikube.io"`

Este comando nos generará dos ficheros 

```
tls.crt
tls.key
```

Con los que crearemos el secreto para Minikube

`kubectl create secret tls curso-minikube-secret --key tls.key --cert tls.crt`

Podemos ver el secreto:

`kubectl get secrets`

```
NAME                      TYPE                                  DATA   AGE
default-token-x24ks       kubernetes.io/service-account-token   3      6d1h
curso-minikube-secret     kubernetes.io/tls                     2      6h
```

3. Desplegamos las aplicaciones

Para la web de gatos:

`kubectl create -f https://raw.githubusercontent.com/codeurjc/Curso-Kubernetes/master/ejemplo1/webgatos-minikube.yaml`

Para la web de los anuncios:

```
kubectl create -f https://raw.githubusercontent.com/codeurjc/Curso-Kubernetes/master/ejemplo2/mysql-service-with-pvc.yaml
kubectl create -f https://raw.githubusercontent.com/codeurjc/Curso-Kubernetes/master/ejemplo2/java-mysql-minikube.yaml
```

4. Configurar el Ingress

Para acceder a los servicios creamos un Ingress con esta forma:

```
apiVersion: extensions/v1beta1  
kind: Ingress  
metadata:  
  name: codeurjc-ingress
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/rewrite-target: "/"
spec:  
  tls:
    - hosts:
      - curso.minikube.io
      secretName: curso-minikube-secret
  rules:
  - host: curso.minikube.io
    http:
      paths:
      - path: /anuncios/
        backend:
          serviceName: java-webapp-db-service
          servicePort: 8080
      - path: /gatos
        backend:
          serviceName: webgatos-service
          servicePort: 5000
```

En la sección de _Metadata_ además del nombre establecemos el tipo de ingress como _nginx_. En otros casos se usar _traefik_. El _rewrite-target_ es la URI de destino donde el tráfico debe ser redirigido. Como nuestras aplicaciones trabajan en / es a donde debemos redirigir el tráfico.

A continuación la sección _tls_ donde definimos el nombre del host junto con el Secret que hemos creado para que el servicio funcione por SSL.

Vemos ahora las reglas. Definimos el path en _/anuncios/_ para la web de anuncios, el motivo que acabe en _/_ es para que las rutas relativas encuentren los enlaces. Así para este _path_ configuramos el servicio y el puerto del servicio.

Igualmente con *gatos* pero como no tiene ningún enlace no hace falta la barra final.

Creamos el Ingress:

`kubectl apply -f ingress.yaml`

5. Accediendo al servicio

Dado que tenemos que usar un DNS vamos a configurar nuestro sistema para que resuelva correctamente, para ello hacemos lo siguiente:

**En Linux**

`sudo echo $(minikube ip) curso.minikube.io >> /etc/hosts`

**En Mac**

Obtener la IP de Minikube

`minikube ip`

Por ejemplo

`192.168.99.100`

Luego editar el fichero

`sudo nano /private/etc/hosts`

y añadir la línea 

`192.168.99.100 curso.minikube.io`

Guardar (Ctrl+o) y salir (Ctrl+x)

**En Windows**

```
1. Presiona la tecla de Windows.
2. Escribe Notepad en campo de búsqueda.
3. En los resultados haz click derecho sobre el icono del Notepad y selecciona ejecutar como administrador.
4. Desde el Notepad abre el fichero: c:\Windows\System32\Drivers\etc\hosts
5. Añade una línea como esta:
192.168.99.100 curso.minikube.io
6. Haz click en Fichero > Guardar para guardar los cambios.
7. Puedes cerrar el Notepad.
```

Ya podremos acceder a los servicios:

- https://curso.minikube.io/gatos
- https://curso.minikube.io/anuncios/

## AWS

Para instalar el Ingress Controller seguimos esta guía

https://kubernetes.github.io/ingress-nginx/deploy/

Y luego desplegamos la aplicación _ejemplo1/webgatos-aws-ingress.yaml_

Vemos la dirección del balanceador

	$ kubectl describe webgatos-service

Y la registramos en Route53 como CNAME con un TTL de 60 segundos.